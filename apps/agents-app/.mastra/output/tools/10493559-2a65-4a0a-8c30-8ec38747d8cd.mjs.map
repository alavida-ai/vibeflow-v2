{"version":3,"file":"10493559-2a65-4a0a-8c30-8ec38747d8cd.mjs","sources":["../../../src/mastra/sessionStore.ts","../../../src/mastra/tools/workflows/get-next-step.ts"],"sourcesContent":["const map = new Map<string, string>();\n\n// Always returns your app-level session id for a given MCP session id\nexport function getAppSessionId(mcpSessionId?: string) {\n    try {\n  // If MCP didn't give you one (edge cases), just make a standalone id\n  if (!mcpSessionId) return crypto.randomUUID();\n\n  let appSid = map.get(mcpSessionId);\n  if (!appSid) {\n            throw new Error(\"No app session id found for mcp session id\");\n        }\n        return appSid;\n    } catch (error) {\n        throw new Error(\"No app session id found for mcp session id\");\n    }\n}\n\n// Optional (debug)\nexport function listSessions() {\n  return Array.from(map.entries()).map(([mcp, app]) => ({ mcpSessionId: mcp, appSessionId: app }));\n}","import { createTool, Tool } from \"@mastra/core\";\nimport { z } from \"zod\";\nimport { getNextStep, getNextStepResultSchema } from \"@brand-listener/agent-sdk\";\nimport { getAppSessionId } from \"../../sessionStore\";\n\n// @ts-ignore\nexport const getNextStepTool: Tool = createTool({\n  id: \"get-next-step\",\n  description: \"Resume the current workflow by marking the previous step as completed and return the next suspend payload (next task). Requires an active workflow started with start-workflow.\",\n  inputSchema: z.object({}), // No input needed - uses runtime context\n  outputSchema: getNextStepResultSchema,\n  execute: async ({ runtimeContext }, options) => {\n    console.log(\"options\", options)\n    try {\n      // @ts-ignore\n      const mcpSid = options?.extra?.sessionId;       // provided by MCP over Hono SSE\n      const appSid = getAppSessionId(mcpSid);  \n      console.log(\"appSid\", appSid)\n      const runId = runtimeContext.get(\"current-run-id\") as string;\n      const workflowId = runtimeContext.get(\"workflowId\") as string;\n\n      if (!runId || !workflowId) {\n        throw new Error(\"No runId or workflowId found\");\n      }\n\n      console.log(\"runId\", runId);\n      console.log(\"workflowId\", workflowId);\n\n      const result = await getNextStep({\n        runId: runId,\n        workflowId: workflowId\n      });\n\n      if (result.status === \"suspended\") {\n        return result;\n      } else if (result.status === \"success\") {\n        runtimeContext.delete(\"current-run-id\");\n        runtimeContext.delete(\"workflowId\");\n        return result;\n      } else {\n        runtimeContext.delete(\"current-run-id\");\n        runtimeContext.delete(\"workflowId\");\n        return result;\n      }\n    } catch (error) {\n      console.error(\"Failed to get next step\", error);\n      throw new Error(`Failed to get next step: ${error instanceof Error ? error.message : String(error)}`);\n    }\n  }\n});"],"names":[],"mappings":";;;;;AAAA,MAAM,GAAA,uBAAU,GAAA,EAAoB;AAG7B,SAAS,gBAAgB,YAAA,EAAuB;AACnD,EAAA,IAAI;AAEN,IAAA,IAAI,CAAC,YAAA,EAAc,OAAO,MAAA,CAAO,UAAA,EAAW;AAE5C,IAAA,IAAI,MAAA,GAAS,GAAA,CAAI,GAAA,CAAI,YAAY,CAAA;AACjC,IAAA,IAAI,CAAC,MAAA,EAAQ;AACH,MAAA,MAAM,IAAI,MAAM,4CAA4C,CAAA;AAAA,IAChE;AACA,IAAA,OAAO,MAAA;AAAA,EACX,SAAS,KAAA,EAAO;AACZ,IAAA,MAAM,IAAI,MAAM,4CAA4C,CAAA;AAAA,EAChE;AACJ;;ACVO,MAAM,kBAAwB,UAAA,CAAW;AAAA,EAC9C,EAAA,EAAI,eAAA;AAAA,EACJ,WAAA,EAAa,iLAAA;AAAA,EACb,WAAA,EAAa,CAAA,CAAE,MAAA,CAAO,EAAE,CAAA;AAAA;AAAA,EACxB,YAAA,EAAc,uBAAA;AAAA,EACd,OAAA,EAAS,OAAO,EAAE,cAAA,IAAkB,OAAA,KAAY;AAC9C,IAAA,OAAA,CAAQ,GAAA,CAAI,WAAW,OAAO,CAAA;AAC9B,IAAA,IAAI;AAEF,MAAA,MAAM,MAAA,GAAS,SAAS,KAAA,EAAO,SAAA;AAC/B,MAAA,MAAM,MAAA,GAAS,gBAAgB,MAAM,CAAA;AACrC,MAAA,OAAA,CAAQ,GAAA,CAAI,UAAU,MAAM,CAAA;AAC5B,MAAA,MAAM,KAAA,GAAQ,cAAA,CAAe,GAAA,CAAI,gBAAgB,CAAA;AACjD,MAAA,MAAM,UAAA,GAAa,cAAA,CAAe,GAAA,CAAI,YAAY,CAAA;AAElD,MAAA,IAAI,CAAC,KAAA,IAAS,CAAC,UAAA,EAAY;AACzB,QAAA,MAAM,IAAI,MAAM,8BAA8B,CAAA;AAAA,MAChD;AAEA,MAAA,OAAA,CAAQ,GAAA,CAAI,SAAS,KAAK,CAAA;AAC1B,MAAA,OAAA,CAAQ,GAAA,CAAI,cAAc,UAAU,CAAA;AAEpC,MAAA,MAAM,MAAA,GAAS,MAAM,WAAA,CAAY;AAAA,QAC/B,KAAA;AAAA,QACA;AAAA,OACD,CAAA;AAED,MAAA,IAAI,MAAA,CAAO,WAAW,WAAA,EAAa;AACjC,QAAA,OAAO,MAAA;AAAA,MACT,CAAA,MAAA,IAAW,MAAA,CAAO,MAAA,KAAW,SAAA,EAAW;AACtC,QAAA,cAAA,CAAe,OAAO,gBAAgB,CAAA;AACtC,QAAA,cAAA,CAAe,OAAO,YAAY,CAAA;AAClC,QAAA,OAAO,MAAA;AAAA,MACT,CAAA,MAAO;AACL,QAAA,cAAA,CAAe,OAAO,gBAAgB,CAAA;AACtC,QAAA,cAAA,CAAe,OAAO,YAAY,CAAA;AAClC,QAAA,OAAO,MAAA;AAAA,MACT;AAAA,IACF,SAAS,KAAA,EAAO;AACd,MAAA,OAAA,CAAQ,KAAA,CAAM,2BAA2B,KAAK,CAAA;AAC9C,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,yBAAA,EAA4B,KAAA,YAAiB,KAAA,GAAQ,MAAM,OAAA,GAAU,MAAA,CAAO,KAAK,CAAC,CAAA,CAAE,CAAA;AAAA,IACtG;AAAA,EACF;AACF,CAAC;;;;"}