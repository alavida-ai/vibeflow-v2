{"version":3,"file":"504824a5-84a6-46c9-aa37-66577deea609.mjs","sources":["../../../src/mastra/tools/workflows/get-next-step.ts"],"sourcesContent":["import { createTool, Tool } from \"@mastra/core\";\nimport { z } from \"zod\";\nimport { getNextStep, getNextStepResultSchema } from \"@brand-listener/agent-sdk\";\nimport { deleteSession, getSession } from \"../../sessions\";\n\n// @ts-ignore\nexport const getNextStepTool: Tool = createTool({\n  id: \"get-next-step\",\n  description: \"Resume the current workflow by marking the previous step as completed and return the next suspend payload (next task). Requires an active workflow started with start-workflow.\",\n  inputSchema: z.object({}), // No input needed - uses runtime context\n  outputSchema: getNextStepResultSchema,\n  execute: async ({ runtimeContext }, options) => {\n    console.log(\"options\", options)\n    // @ts-ignore\n    const mcpSid = options?.extra?.sessionId;       // provided by MCP over Hono SSE\n    console.log(\"appSid\", mcpSid)\n    \n    if (!mcpSid) {\n      throw new Error(\"Session ID is required but not provided. Make sure the MCP client is properly configured.\");\n    }\n    \n    const session = getSession(mcpSid);\n    try {\n      const runId = session?.workflow?.runId;\n      const workflowId = session?.workflow?.workflowId;\n\n      if (!runId || !workflowId) {\n        throw new Error(\"No runId or workflowId found from session\");\n      }\n\n      console.log(\"runId\", runId);\n      console.log(\"workflowId\", workflowId);\n\n      const result = await getNextStep({\n        runId: runId,\n        workflowId: workflowId\n      });\n\n      if (result.status === \"suspended\") {\n        return result;\n      } else if (result.status === \"success\") {\n        deleteSession(mcpSid);\n        return result;\n      } else {\n        deleteSession(mcpSid);\n        return result;\n      }\n    } catch (error) {\n      console.error(\"Failed to get next step\", error);\n      throw new Error(`Failed to get next step: ${error instanceof Error ? error.message : String(error)}`);\n    }\n  }\n});"],"names":[],"mappings":";;;;;AAMO,MAAM,kBAAwB,UAAA,CAAW;AAAA,EAC9C,EAAA,EAAI,eAAA;AAAA,EACJ,WAAA,EAAa,iLAAA;AAAA,EACb,WAAA,EAAa,CAAA,CAAE,MAAA,CAAO,EAAE,CAAA;AAAA;AAAA,EACxB,YAAA,EAAc,uBAAA;AAAA,EACd,OAAA,EAAS,OAAO,EAAE,cAAA,IAAkB,OAAA,KAAY;AAC9C,IAAA,OAAA,CAAQ,GAAA,CAAI,WAAW,OAAO,CAAA;AAE9B,IAAA,MAAM,MAAA,GAAS,SAAS,KAAA,EAAO,SAAA;AAC/B,IAAA,OAAA,CAAQ,GAAA,CAAI,UAAU,MAAM,CAAA;AAE5B,IAAA,IAAI,CAAC,MAAA,EAAQ;AACX,MAAA,MAAM,IAAI,MAAM,2FAA2F,CAAA;AAAA,IAC7G;AAEA,IAAA,MAAM,OAAA,GAAU,WAAW,MAAM,CAAA;AACjC,IAAA,IAAI;AACF,MAAA,MAAM,KAAA,GAAQ,SAAS,QAAA,EAAU,KAAA;AACjC,MAAA,MAAM,UAAA,GAAa,SAAS,QAAA,EAAU,UAAA;AAEtC,MAAA,IAAI,CAAC,KAAA,IAAS,CAAC,UAAA,EAAY;AACzB,QAAA,MAAM,IAAI,MAAM,2CAA2C,CAAA;AAAA,MAC7D;AAEA,MAAA,OAAA,CAAQ,GAAA,CAAI,SAAS,KAAK,CAAA;AAC1B,MAAA,OAAA,CAAQ,GAAA,CAAI,cAAc,UAAU,CAAA;AAEpC,MAAA,MAAM,MAAA,GAAS,MAAM,WAAA,CAAY;AAAA,QAC/B,KAAA;AAAA,QACA;AAAA,OACD,CAAA;AAED,MAAA,IAAI,MAAA,CAAO,WAAW,WAAA,EAAa;AACjC,QAAA,OAAO,MAAA;AAAA,MACT,CAAA,MAAA,IAAW,MAAA,CAAO,MAAA,KAAW,SAAA,EAAW;AACtC,QAAA,aAAA,CAAc,MAAM,CAAA;AACpB,QAAA,OAAO,MAAA;AAAA,MACT,CAAA,MAAO;AACL,QAAA,aAAA,CAAc,MAAM,CAAA;AACpB,QAAA,OAAO,MAAA;AAAA,MACT;AAAA,IACF,SAAS,KAAA,EAAO;AACd,MAAA,OAAA,CAAQ,KAAA,CAAM,2BAA2B,KAAK,CAAA;AAC9C,MAAA,MAAM,IAAI,KAAA,CAAM,CAAA,yBAAA,EAA4B,KAAA,YAAiB,KAAA,GAAQ,MAAM,OAAA,GAAU,MAAA,CAAO,KAAK,CAAC,CAAA,CAAE,CAAA;AAAA,IACtG;AAAA,EACF;AACF,CAAC;;;;"}