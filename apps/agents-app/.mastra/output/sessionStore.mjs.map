{"version":3,"file":"sessionStore.mjs","sources":["../.build/@brand-listener-agent-sdk.mjs","../../src/mastra/sessionStore.ts"],"sourcesContent":["import { MastraClient } from '@mastra/client-js';\nimport { z } from 'zod';\n\nclass VibeflowAgentClient {\n  baseUrl;\n  constructor(baseUrl) {\n    if (!baseUrl) {\n      throw new Error(\"Base URL is required\");\n    }\n    this.baseUrl = baseUrl;\n  }\n  async createMastraClient() {\n    try {\n      return new MastraClient({\n        baseUrl: this.baseUrl\n      });\n    } catch (error) {\n      console.error(\"Error creating Mastra client\", error);\n      throw new Error(\"Error creating Mastra client\");\n    }\n  }\n  async createMastraAgent(agentName) {\n    if (!agentName) {\n      throw new Error(\"Agent name is required\");\n    }\n    const mastraClient = await this.createMastraClient();\n    const agent = mastraClient.getAgent(agentName);\n    if (!agent) {\n      throw new Error(\"Agent not found\");\n    }\n    return agent;\n  }\n}\n\nconst startWorkflowResultSchema = z.object({\n  runId: z.string().optional(),\n  suspendPayload: z.any().optional(),\n  status: z.enum([\"suspended\"]).optional()\n});\nconst getNextStepResultSchema = z.object({\n  suspendPayload: z.any().optional(),\n  status: z.enum([\"suspended\", \"success\"]).optional()\n});\nconst VIBEFLOW_BASE_URL = process.env.VIBEFLOW_BASE_URL || \"http://localhost:4111/\";\nasync function startWorkflow(workflowId) {\n  const vibeflowAgentClient = new VibeflowAgentClient(VIBEFLOW_BASE_URL);\n  const mastraClient = await vibeflowAgentClient.createMastraClient();\n  try {\n    const workflow = mastraClient.getWorkflow(workflowId);\n    const run = await workflow.createRun();\n    const result = await workflow.startAsync({\n      runId: run.runId,\n      inputData: {\n        start: true\n      }\n    });\n    console.log(\"Started workflow, run ID:\", run.runId, result);\n    if (result.status === \"suspended\" && result.suspended.length > 0) {\n      const suspendedStepName = result.suspended[0][0];\n      const suspendPayload = result.steps[suspendedStepName].suspendPayload;\n      return {\n        runId: run.runId,\n        suspendPayload,\n        status: \"suspended\"\n      };\n    } else if (result.status === \"success\") {\n      throw new Error(\"You forgot to add a suspended step to your workflow\");\n    } else {\n      throw new Error(\"Workflow failed to start\");\n    }\n  } catch (error) {\n    throw new Error(`Failed to start workflow: ${error instanceof Error ? error.message : String(error)}`);\n  }\n}\nasync function getNextStep({\n  runId,\n  workflowId\n}) {\n  if (!workflowId || !runId) {\n    throw new Error(\"No active workflow runId or workflowId found. Please start a workflow first.\");\n  }\n  try {\n    const vibeflowAgentClient = new VibeflowAgentClient(VIBEFLOW_BASE_URL);\n    const mastraClient = await vibeflowAgentClient.createMastraClient();\n    const workflow = mastraClient.getWorkflow(workflowId);\n    const currentState = await workflow.runExecutionResult(runId);\n    console.log(\"currentState\", currentState);\n    let step = null;\n    if (currentState.status === \"suspended\") {\n      const suspendedSteps = Object.entries(currentState.steps).filter(([, stepState]) => stepState.status === \"suspended\");\n      if (suspendedSteps.length > 0) {\n        step = suspendedSteps[0][0];\n        console.log(\"step\", step);\n      }\n    }\n    if (!step) {\n      throw new Error(\"No suspended step found to resume\");\n    }\n    const result = await workflow.resumeAsync({\n      runId,\n      step,\n      resumeData: {\n        stepCompleted: true\n      }\n    });\n    if (result.status === \"suspended\" && result.suspended.length > 0) {\n      const nextSuspendedStepName = result.suspended[0][0];\n      const nextSuspendPayload = result.steps[nextSuspendedStepName].suspendPayload;\n      return {\n        suspendPayload: nextSuspendPayload,\n        status: \"suspended\"\n      };\n    } else if (result.status === \"success\") {\n      return {\n        status: \"success\"\n      };\n    } else {\n      throw new Error(\"Workflow failed to resume\");\n    }\n  } catch (error) {\n    throw new Error(`Failed to get next step: ${error instanceof Error ? error.message : String(error)}`);\n  }\n}\n\nexport { getNextStep, getNextStepResultSchema, startWorkflow, startWorkflowResultSchema };\n","const map = new Map<string, string>();\n\n// Always returns your app-level session id for a given MCP session id\nexport function getAppSessionId(mcpSessionId?: string) {\n    try {\n        \n  let appSid = map.get(mcpSessionId);\n  if (!appSid) {\n            throw new Error(\"No app session id found for mcp session id\");\n        }\n        return appSid;\n    } catch (error) {\n        throw new Error(\"No app session id found for mcp session id\");\n    }\n}\n\n// Optional (debug)\nexport function listSessions() {\n  return Array.from(map.entries()).map(([mcp, app]) => ({ mcpSessionId: mcp, appSessionId: app }));\n}"],"names":[],"mappings":"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"}